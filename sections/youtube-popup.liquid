{%- liquid
  assign video_type = section.settings.video_type
  assign autoplay = section.settings.autoplay

  # YouTube视频处理
  if video_type == 'youtube' and section.settings.youtube_url != blank
    assign video_id = section.settings.youtube_url | split: 'v=' | last | split: '&' | first

    # 修正后的封面图逻辑
    if section.settings.custom_thumbnail != blank
      assign thumbnail_url = section.settings.custom_thumbnail | img_url: '800x'
    else
      assign thumbnail_url = 'https://img.youtube.com/vi/' | append: video_id | append: '/mqdefault.jpg'
    endif

    assign embed_url = 'https://www.youtube.com/embed/' | append: video_id | append: '?autoplay=1&rel=0'
  endif

  # Shopify自有视频处理
  if video_type == 'shopify' and section.settings.shopify_video != blank
    assign video_url = section.settings.shopify_video
    assign thumbnail_url = section.settings.cover_image | default: settings.video_thumbnail | img_url: '800x'
  endif
-%}
<style>
   #shopify-section-{{ section.id }}{margin-top:{{section.settings.padding_top  }}px;margin-bottom:{{section.settings.padding_bottom  }}px;}
   .video-popup-section {
     position: relative;
   }

  #shopify-section-{{ section.id }} .video-container {
     cursor: pointer;
     position: relative;
     overflow: hidden;
     margin: 0 auto;
     border-radius: 32px;
     transition: transform 0.3s ease;
   }

   #shopify-section-{{ section.id }} .video-thumbnail {
     width: 100%;
     height: 100%;
     object-fit: cover;
     transition: opacity 0.3s ease;
   }

   #shopify-section-{{ section.id }} .video-placeholder {
     width: 100%;
     height: 100%;
     background: #f5f5f5;
     display: flex;
     align-items: center;
     justify-content: center;
   }

   #shopify-section-{{ section.id }} .play-button {
     position: absolute;
     top: 50%;
     left: 50%;
     transform: translate(-50%, -50%);
     width: 50px;
     height: 50px;
     display: none;
     justify-content: center;
     align-items: center;
     color:#fff;
     transition: transform 0.2s ease;
   }

   #shopify-section-{{ section.id }} .video-modal {
     display: none;
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     z-index: 1000;
      background-color: rgba(0, 0, 0, 0.9);
     justify-content: center;
     align-items: center;
     opacity: 0;
     transition: opacity 0.3s ease;
   }

   #shopify-section-{{ section.id }} .video-modal.active {
     display: flex;
     opacity: 1;
   }

   #shopify-section-{{ section.id }} .modal-content {
     width: 90%;
     max-width: 1000px;
     position: relative;
   }

   #shopify-section-{{ section.id }} .close-button {
     position: absolute;
     top: -50px;
     right: 0;
     padding:0px;
     background: none;
     border: none;
     cursor: pointer;
     transition: transform 0.2s ease;
   }

  #shopify-section-{{ section.id }}  .close-button:hover {
     transform: scale(1.2);
   }

   #shopify-section-{{ section.id }} .video-player {
     position: relative;
     padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
     height: 0;
     overflow: hidden;
   }

  #shopify-section-{{ section.id }} .youtube-iframe,
  #shopify-section-{{ section.id }} .shopify-video {
     position: absolute;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     border: none;
   }

   @media (max-width: 767.98px) {
     #shopify-section-{{ section.id }}{
         display: flex;
         justify-content:
           {% case section.settings.alignment %}
             {% when 'left' %}flex-start
             {% when 'center' %}center
             {% when 'right' %}flex-end
           {% endcase %};
         margin-top:{{section.settings.padding_top | divided_by: 2  }}px;margin-bottom:{{section.settings.padding_bottom | divided_by: 2  }}px;}
     #shopify-section-{{ section.id }} .video-container{ width: 200px!important;height:36px!important}
     #shopify-section-{{ section.id }} .modal-content {
       width: 95%;
     }

    #shopify-section-{{ section.id }} .close-button {
       top: -40px;
     }
   }
</style>
<div class="video-popup-section" data-section-id="{{ section.id }}">
  <div
    class="video-container"
    style="width: {{ section.settings.video_width }}px; height: {{ section.settings.video_height }}px;"
    data-video-type="{{ video_type }}"
    {% if video_type == 'youtube' %}
      data-youtube-id="{{ video_id }}"
    {% endif %}
    {% if video_type == 'shopify' %}
      data-shopify-video="{{ video_url }}"
    {% endif %}
  >
    {% if thumbnail_url %}
      <img
        class="video-thumbnail"
        src="{{ thumbnail_url }}"
        alt="{{ section.settings.alt_text }}"
        loading="lazy"
        width="300"
        height="64"
      >
    {% else %}
      <div class="video-placeholder">{{ 'video' | placeholder_svg_tag: 'placeholder-svg' }}</div>
    {% endif %}

    <div class="play-button" aria-label="Play video">
      {% comment %}
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="24px" height="24px">
          <path d="M8 5v14l11-7z"/>
        </svg>
      {% endcomment %}
    </div>
  </div>

  <div class="video-modal">
    <div class="modal-content">
      <button class="close-button" aria-label="Close video">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="24px" height="24px">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>

      <div class="video-player">
        {% if video_type == 'youtube' and video_id %}
          <iframe
            class="youtube-iframe"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        {% elsif video_type == 'shopify' and video_url %}
          <video
            class="shopify-video"
            {% if autoplay %}
              autoplay muted
            {% endif %}
            loop
            controls
            playsinline
          >
            <source src="{{ video_url }}" type="video/mp4">
          </video>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sections = document.querySelectorAll('.video-popup-section');
    sections.forEach(section => {
      const container = section.querySelector('#shopify-section-{{ section.id }} .video-container');
      const modal = section.querySelector('.video-modal');
      const closeBtn = section.querySelector('.close-button');
      const videoType = container.dataset.videoType;
      // 点击容器打开弹窗
      container.addEventListener('click', function() {
        if (videoType === 'youtube') {
          const iframe = section.querySelector('.youtube-iframe');
          const videoId = container.dataset.youtubeId;
          iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
        } 
        else if (videoType === 'shopify') {
          const video = section.querySelector('.shopify-video');
          if (video) video.play();
        }
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      });
      
      // 关闭弹窗
      function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        
        if (videoType === 'youtube') {
          const iframe = section.querySelector('.youtube-iframe');
          iframe.src = '';
        } 
        else if (videoType === 'shopify') {
          const video = section.querySelector('.shopify-video');
          if (video) {
            video.pause();
            video.currentTime = 0;
          }
        }
      }
      
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
      });
      
      // 自动播放处理（仅限Shopify视频）
      {% if video_type == 'shopify' and autoplay %}
        if (videoType === 'shopify') {
          const video = section.querySelector('.shopify-video');
          if (video) {
            // 延迟执行以避免自动播放策略限制
            setTimeout(() => {
              video.play().catch(e => console.log('Autoplay prevented:', e));
            }, 1000);
          }
        }
      {% endif %}
    });
  });
</script>

{% schema %}
{
  "name": "Video Popup Player",
  "settings": [
    {
      "type": "select",
      "id": "alignment",
      "label": "Video Mobile Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "video_type",
      "label": "Video Type",
      "options": [
        {
          "value": "youtube",
          "label": "YouTube"
        },
        {
          "value": "shopify",
          "label": "Shopify Video"
        }
      ],
      "default": "youtube"
    },
    {
      "type": "video_url",
      "id": "youtube_url",
      "label": "YouTube Video URL",
      "accept": ["youtube"],
      "info": "Paste YouTube video URL",
      "default": "https://www.youtube.com/watch?v=MDleTF2lBbQ"
    },
    {
      "type": "image_picker",
      "id": "custom_thumbnail",
      "label": "Custom Thumbnail",
      "info": "上传自定义封面图（可选）"
    },
    {
      "type": "text",
      "id": "shopify_video",
      "label": "Shopify Video URL",
      "info": "Upload video in Settings > Files and paste URL here"
    },
    {
      "type": "image_picker",
      "id": "cover_image",
      "label": "Cover Image",
      "info": "Only for Shopify videos"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Autoplay (Shopify only)",
      "default": true,
      "info": "Note: Most browsers block autoplay with sound"
    },
    {
      "type": "text",
      "id": "alt_text",
      "label": "Alt Text",
      "default": "Video thumbnail"
    },
    {
      "type": "range",
      "id": "video_width",
      "default": 200,
      "min": 100,
      "max": 500,
      "step": 10,
      "unit": "px",
      "label": "Container Width"
    },
    {
      "type": "range",
      "id": "video_height",
      "default": 64,
      "min": 64,
      "max": 324,
      "step": 10,
      "unit": "px",
      "label": "Container Height"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "t:sections.all.padding.padding_top",
      "default": 60,
      "min": 0,
      "max": 120,
      "step": 2,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 60,
      "min": 0,
      "max": 120,
      "step": 2,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "Video Popup Player",
      "category": "自定义产品组件"
    }
  ]
}
{% endschema %}
