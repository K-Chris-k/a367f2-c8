{%- if request.page_type != 'cart' and settings.cart_type == 'drawer' -%}
  {%- if request.page_type == 'cart' -%}
    {{ 'cart.css' | asset_url | stylesheet_tag }}
  {%- else -%}
    <link
      rel="stylesheet"
      href="{{ 'cart.css' | asset_url }}"
      media="print"
      fetchpriority="low"
      onload="this.media='all'"
    >
  {%- endif -%}
  <script src="{{ 'cart.js' | asset_url }}" defer="defer"></script>
  {%- if linklists['gift-wrapping'].links != blank and linklists['gift-wrapping'].links.first.type == 'product_link' -%}
    <script src="{{ 'gift-wrapping.js' | asset_url }}" defer="defer"></script>
  {%- endif -%}

  <cart-drawer
    id="CartDrawer"
    class="drawer cart-drawer drawer--right"
    data-section-id="{{ section.id }}"
    shopify-design-mode
    hidden
  >
    <div class="fixed-overlay" aria-controls="CartDrawer"></div>
    <div class="drawer__inner">
      <button
        class="drawer__close-btn z-1"
        aria-controls="CartDrawer"
        type="button"
        aria-label="{{ 'templates.cart.cart' | t }}"
      >
        {% render 'icon-close', size: 'large' %}
      </button>
      <div id="CartDrawer-{{ section.id }}" class="drawer__content flex flex-col h-full w-full">
        <div class="drawer__header cart-drawer__header flex flex-col gap-5 items-start">
          <h2 class="drawer__heading h3 flex items-center gap-3">
            <span>{{ 'general.cart.title' | t }}</span>
            <cart-count
              class="cart-count cart-count--medium font-body-bolder"
              aria-label="{{ 'general.cart.cart_count' | t: count: cart.item_count | escape }}"
              {% if cart == empty %}
                hidden
              {% endif %}
            >
              {%- if cart.item_count < 100 -%}
                {{- cart.item_count -}}
              {%- else -%}
                <span class="text-sm">99+</span>
              {%- endif -%}
            </cart-count>
          </h2>
          {%- liquid
            if section.settings.show_free_shipping_goal and settings.free_shipping_minimum_amount != blank
              assign minimum_amount = settings.free_shipping_minimum_amount | remove: ' '
              render 'free-shipping-goal', minimum_amount: minimum_amount, classes: 'w-full'
            endif
          -%}
        </div>
        <div
          id="CartDrawerEmpty-{{ section.id }}"
          class="drawer__body flex-grow v-scrollable{% if cart != empty %} hidden{% endif %}"
        >
          <div class="cart-drawer__empty text-center grid gap-10">
            <div class="grid gap-3">
              <p class="h4">{{ 'sections.cart.empty' | t }}</p>
              {%- if settings.cart_empty_message != blank -%}
                <div class="rte">{{ settings.cart_empty_message }}</div>
              {%- endif -%}
            </div>
            {%- if settings.collection_list != blank -%}
              <ul class="recommendation-collection flex flex-col gap-4" role="list">
                {%- for collection in settings.collection_list -%}
                  {%- liquid
                    assign collection_image = collection.featured_image
                    assign first_product_in_collection = collection.products[0]

                    if collection_image == blank
                      assign collection_image = first_product_in_collection.featured_image
                    endif
                  -%}
                  <li class="recommendation-collection-item blocks-radius flex-grow flex items-center">
                    <a href="{{ collection.url }}" class="w-full flex items-center gap-3">
                      <div class="recommendation-collection-item__image blocks-radius-sm media-wrapper">
                        {%- if collection_image != blank -%}
                          {{-
                            collection_image
                            | image_url: width: collection_image.width
                            | image_tag: loading: 'lazy', widths: '180,360,540', is: 'image-lazy', alt: ''
                          -}}
                        {%- else -%}
                          <div style="--aspect-ratio: 1;">
                            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                          </div>
                        {%- endif -%}
                      </div>
                      <div class="recommendation-collection-item__content flex items-center justify-between flex-grow">
                        <h3 class="recommendation-collection-item__title h5 font-body-bolder">
                          {{ collection.title | escape }}
                        </h3>
                        <button
                          class="btn btn--icon-circle btn--secondary shrink-0"
                          aria-label="{{ collection.title | escape }}"
                        >
                          <svg
                            class="icon icon--medium rtl-flip-x"
                            width="20"
                            height="20"
                            viewBox="0 0 20 20"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                          >
                            <path d="M5 15L15 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6.875 5H15V13.125" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </div>
                    </a>
                  </li>
                {%- endfor -%}
              </ul>
            {%- else -%}
              <a class="btn btn--secondary" href="{{ routes.all_products_collection_url }}">
                {{- 'general.cart.continue_shopping' | t -}}
              </a>
            {%- endif -%}
          </div>
        </div>
        <div
          id="CartDrawerBody-{{ section.id }}"
          class="drawer__body cart-drawer__body flex-grow v-scrollable{% if cart == empty %} hidden{% endif %}"
        >
          <div class="flex flex-col gap-8">
            {%- liquid
              if linklists['gift-wrapping'].links != blank and linklists['gift-wrapping'].links.first.type == 'product_link'
                assign gift_wrapping = linklists['gift-wrapping'].links.first

                assign gift_wrap_id = gift_wrapping.object.variants.first.id
                assign gift_wraps_in_cart = 0
                for item in cart.items
                  if item.id == gift_wrap_id
                    assign gift_wraps_in_cart = item.quantity
                    break
                  endif
                endfor
                assign items_in_cart = cart.item_count | minus: gift_wraps_in_cart
              endif
            -%}
            <cart-items>
              <ul role="list" class="flex flex-col gap-8">
                {%- for item in cart.items -%}
                  {%- liquid
                    assign is_gift_wrap_item = false
                    if gift_wrap_id != null and item.id == gift_wrap_id
                      assign is_gift_wrap_item = true
                    endif
                  -%}
                  {%- capture cart_item -%}
                  {%- liquid
                    # 检查是否是 Bundle 产品
                    assign is_bundle_item = false
                    for property in item.properties
                      if property.first == '_bundle_item' and property.last == 'true'
                        assign is_bundle_item = true
                        break
                      endif
                    endfor
                  -%}
                  <li id="CartDrawer-Item-{{ item.index | plus: 1 }}" class="cart-item flex flex-col gap-4" data-variant-id="{{ item.variant_id }}" data-product-id="{{ item.product_id }}" data-handle="{{ item.product.handle }}" data-quantity="{{ item.quantity }}" data-price="{{ item.original_price }}" {% if item.properties._free_gift == 'true' %}data-free-gift="true"{% endif %}>
                    <div class="cart-item__product flex items-start gap-3">
                      {%- if item.image -%}
                        <a class="cart-item__media blocks-radius-sm media-wrapper" href="{{ item.url }}" tabindex="-1" aria-label="{{ item.title }}">
                          {{- item.image 
                            | image_url: width: item.image.width
                            | image_tag:
                            loading: 'lazy',
                            widths: '80, 100, 160, 200',
                            sizes: '(max-width: 767px) 80px, 100px',
                            is: 'image-lazy' 
                          -}}
                        </a>
                      {%- endif -%}
                      <div class="cart-item__details flex-grow flex flex-col gap-2">
                        <div class="grid">
                          <div class="block"><a href="{{ item.url }}" class="cart-item__title text-pcard-title reversed-link">{{- item.product.title | escape -}}</a></div>
                          {%- if item.product.has_only_default_variant == false or item.properties.size != 0 or item.selling_plan_allocation != null -%}
                            <div class="cart-item__options">
                              {%- if item.product.has_only_default_variant == false -%}
                                {%- assign last_index = item.options_with_values.size | minus: 1 -%}
                                {%- for option in item.options_with_values -%}
                                  <span class="cart-item__option-value text-sm text-subtext">
                                    {{ option.value }}{% unless forloop.index0 == last_index %}, {% endunless %}
                                  </span>
                                {%- endfor -%}
                              {%- endif -%}
      
                              {%- for property in item.properties -%}
                                {%- assign property_first_char = property.first | slice: 0 -%}
                                {%- if property.last != blank and property_first_char != '_' -%}
                                  <div class="flex gap-1 text-sm text-subtext">
                                    <dt>{{ property.first }}:&nbsp;</dt>
                                    <dd class="m-0">
                                      {%- if property.last contains '/uploads/' -%}
                                        <a href="{{ property.last }}" class="link" target="_blank" aria-describedby="a11y-new-window-message">
                                          {{- property.last | split: '/' | last -}}
                                        </a>
                                      {%- else -%}
                                        {{- property.last -}}
                                      {%- endif -%}
                                    </dd>
                                  </div>
                                {%- endif -%}
                              {%- endfor -%}
                              {%- if item.selling_plan_allocation != null -%}
                                <p class="text-sm text-subtext">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                              {%- endif -%}
                            </div>
                          {%- endif -%}
                          <div class="cart-item__prices">
                            <div class="price font-body-bolder{% if item.original_price != item.final_price %} price--on-sale{% endif %}">
                              {%- liquid
                                assign money_price = item.original_price | money
                                if settings.currency_code_enabled
                                  assign money_price = item.original_price | money_with_currency
                                endif
                              -%}
                              {%- if item.original_price != item.final_price -%}
                                <span class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</span>
                                <s class="price__sale font-body text-sm text-subtext">{{ money_price }}</s>
                                <span class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</span>
                                <span class="price__regular">
                                  {%- liquid 
                                    if settings.currency_code_enabled
                                      echo item.final_price | money_with_currency
                                    else
                                      echo item.final_price | money
                                    endif  
                                  -%}
                                </span>
                              {%- else -%}
                                {{- money_price -}}
                              {%- endif -%}
                            </div>
                              {%- if item.variant.available and item.unit_price_measurement -%}
                                <div>
                                <span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
                                <span class="unit-price flex items-center text-sm font-body text-subtext">
                                  {%- liquid
                                    capture unit_price_base_unit
                                      if item.variant.unit_price_measurement
                                        if item.variant.unit_price_measurement.reference_value != 1
                                          echo item.variant.unit_price_measurement.reference_value
                                        endif
                                        echo item.variant.unit_price_measurement.reference_unit
                                      endif
                                    endcapture
                                  -%}
                                  ({{ item.variant.unit_price | money }}
                                  <span aria-hidden="true">/</span>
                                  <span class="visually-hidden">&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span>
                                  {{ unit_price_base_unit }})
                                  </span>
                                </div>
                              {%- endif -%}
                          </div>
                        </div>
                        {%- if item.line_level_discount_allocations != blank -%}
                          <ul class="cart-item__discounts discounts list-unstyled flex flex-wrap gap-1" role="list" aria-label="{{ 'customer.order.discount' | t }}">
                            {%- for discount_allocation in item.line_level_discount_allocations -%}
                              <li class="discount text-sm inline-flex items-center">
                                {% render 'icon-discount' %}
                                <span>{{ discount_allocation.discount_application.title }}</span>
                              </li>
                            {%- endfor -%}
                          </ul>
                        {%- endif -%}
                      </div>
                      <div class="cart-item__action flex flex-col items-end justify-end gap-4">
                        <a id="Loader-{{ section.id }}-{{ item.index | plus: 1 }}"{% unless is_gift_wrap_item %} is="cart-remove-item"{% else %} is="gift-wrap-remove-item"{% endunless %} class="cart-item__remove flex items-center justify-center relative" href="{{ item.url_to_remove }}" data-index="{{ item.index | plus: 1 }}" aria-label="{{ 'sections.cart.remove_title' | t: title: item.title }}">
                          <span class="flex">
                            {%- render 'icon-close', size: 'small' -%}
                          </span>
                          {% render 'loading-spinner' %}
                        </a>

                        {%- liquid 
                          assign has_qty_rules = false
                          if item.variant.quantity_rule.increment > 1 or item.variant.quantity_rule.min > 1 or item.variant.quantity_rule.max != null
                            assign has_qty_rules = true
                          endif

                          assign has_vol_pricing = false
                          if item.variant.quantity_price_breaks.size > 0
                            assign has_vol_pricing = true
                          endif
                        -%}

                        {%- if has_qty_rules or has_vol_pricing -%}
                          {%- capture qty_rules_vol_pricing -%}
                            {%- if has_qty_rules -%}
                              <div
                                class="quantity__rules text-sm"
                              >
                                {%- if item.variant.quantity_rule.increment > 1 -%}
                                  <span class="divider">
                                    {{-
                                      'products.product.quantity.multiples_of'
                                      | t: quantity: item.variant.quantity_rule.increment
                                    -}}
                                  </span>
                                {%- endif -%}
                                {%- if item.variant.quantity_rule.min > 1 -%}
                                  <span class="divider">
                                    {{-
                                      'products.product.quantity.minimum_of'
                                      | t: quantity: item.variant.quantity_rule.min
                                    -}}
                                  </span>
                                {%- endif -%}
                                 {% if item.variant.quantity_rule.max != null %}
                                 <span class="divider">
                                    {{-
                                      'products.product.quantity.maximum_of'
                                      | t: quantity: item.variant.quantity_rule.max
                                    -}}
                                  </span>
                                {% elsif  item.variant.id=='7850335305827' %}  
                                  max="1"
                                {% endif %}
                              </div>
                            {%- endif -%}
                            {%- if has_vol_pricing -%}
                              {{ 'component-volume-pricing.css' | asset_url | stylesheet_tag }}
                              <volume-pricing class="block parent-display blocks-radius-md" id="Volume-{{ section.id }}">
                                <span class="caption block">{{ 'products.product.volume_pricing.title' | t }}</span>
                                <ul class="list-unstyled">
                                  <li class="blocks-radius-md">
                                    <span>{{ item.variant.quantity_rule.min }}+</span>
                                    {%- liquid 
                                      if settings.currency_code_enabled
                                        assign price = item.variant.price | money_with_currency
                                      else
                                        assign price = item.variant.price | money
                                      endif
                                    -%}
                                    <span> {{ 'products.product.volume_pricing.each_html' | t: money: price }}</span>
                                  </li>
                                  {%- for price_break in item.variant.quantity_price_breaks -%}
                                    <li class="blocks-radius-md">
                                      <span>
                                        {{- price_break.minimum_quantity -}}
                                        <span aria-hidden="true">+</span>
                                      </span>
                                      {%- liquid 
                                        if settings.currency_code_enabled
                                          assign price_break_price = price_break.price | money_with_currency
                                        else
                                          assign price_break_price = price_break.price | money
                                        endif
                                      -%}
                                      <span>{{ 'products.product.volume_pricing.each_html' | t: money: price_break_price }}</span>
                                    </li>
                                  {%- endfor -%}
                                </ul>
                              </volume-pricing>
                            {%- endif -%}
                          {%- endcapture -%}
                        {%- endif -%}
                        <div class="flex items-center gap-2">
                          {% if has_qty_rules or has_vol_pricing %}
                            <button class="btn btn--plain" aria-controls="VolumnPricing-{{ section.id }}-{{ item.key }}">
                              <svg class="icon icon-info icon--medium" viewBox="0 0 25 24" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12.5 16V11M13 8C13 8.27614 12.7761 8.5 12.5 8.5C12.2239 8.5 12 8.27614 12 8M13 8C13 7.72386 12.7761 7.5 12.5 7.5C12.2239 7.5 12 7.72386 12 8M13 8H12M22.5 12C22.5 17.5228 18.0228 22 12.5 22C6.97715 22 2.5 17.5228 2.5 12C2.5 6.47715 6.97715 2 12.5 2C18.0228 2 22.5 6.47715 22.5 12Z"></path>
                              </svg>
                            </button>
                            <modal-component class="drawer cart-addons-drawer drawer--bottom" id="VolumnPricing-{{ section.id }}-{{ item.key }}" hidden>
                              <div class="fixed-overlay absolute" aria-controls="VolumnPricing-{{ section.id }}-{{ item.key }}"></div>
                              <div class="drawer__inner v-scrollable">
                                <button aria-controls="VolumnPricing-{{ section.id }}-{{ item.key }}" class="drawer__close-btn z-1">
                                  {%- render 'icon-close' -%}
                                </button>
                                <div class="drawer__content cart-addons-drawer__content grid gap-5">
                                  <div>
                                    <h4>{{ item.product.title | escape }}</h4>
                                    {% if item.product.has_only_default_variant == false %}
                                      <div class="flex gap-1">
                                        {% for option in item.options_with_values %}
                                          <span class="text-sm text-subtext">{{ option.value }}{% unless forloop.index0 == last_index %},{% endunless %}</span>
                                        {% endfor %}
                                      </div>
                                    {% endif %}
                                  </div>
                                  <div class="grid gap-3">
                                    {{ qty_rules_vol_pricing }}
                                  </div>
                                </div>
                              </div>
                            </modal-component>
                          {% endif %}

                          {%- unless is_gift_wrap_item -%}
                            <quantity-input class="cart-quantity quantity">
                              <label class="visually-hidden" for="Quantity-{{ section.id }}-{{ item.index | plus: 1 }}"></label>
                              <button type="button" name="minus" class="quantity__button" aria-label="{{ 'products.product.quantity.decrease' | t: product: item.product.title | escape }}">
                                <svg width="16" height="16" viewBox="0 0 15 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <path d="M2.6875 7H12.3125" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                              </button>
                              <input class="quantity__input"
                                type="number"
                                name="updates[]"
                                value="{{ item.quantity }}"
                                id="Quantity-{{ section.id }}-{{ item.index | plus: 1 }}"
                                aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                                step="{{ item.variant.quantity_rule.increment }}"
                                size="2"
                                inputmode="numeric"
                                autocomplete="off"
                                data-index="{{ item.index | plus: 1 }}"
                                data-quantity-variant-id="{{ item.variant.id }}"
                                data-cart-quantity="{{ cart | item_count_for_variant: item.variant.id }}"
                                min="0"
                                data-min="{{ item.variant.quantity_rule.min }}" 
                                data-item="{{item.variant.id }}"
                          {%- assign is_gift = false -%}
                          {%- if item.variant.product.tags contains 'max_quantity: 1' or item.product.tags contains 'max_quantity: 1' -%}
                            {%- assign is_gift = true -%}
                          {%- endif -%}

                          {%- assign max_quantity = nil -%}
                          {%- if is_gift -%}
                            {%- assign max_quantity = 1 -%}
                          {%- elsif item.variant.quantity_rule.max != null -%}
                            {%- assign max_quantity = item.variant.quantity_rule.max -%}
                          {%- endif -%}

                            {%- comment -%} 如果有最大数量限制，则输出属性 {%- endcomment -%}
                            {%- if max_quantity != null -%}
                              data-max="{{ max_quantity }}" max="{{ max_quantity }}"
                            {%- endif -%}
                              />
                              <button type="button" name="plus" class="quantity__button" aria-label="{{ 'products.product.quantity.increase' | t: product: item.product.title | escape }}">
                                <svg width="16" height="16" viewBox="0 0 15 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <path d="M2.6875 7H12.3125" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                  <path d="M7.5 2.1875V11.8125" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                              </button>
                            </quantity-input>
                          {%- else -%}
                            <div class="cart-quantity quantity cart-quantity-gift-wrap">
                              <label class="visually-hidden" for="Quantity-{{ section.id }}-{{ item.index | plus: 1 }}"></label>
                              <button type="button" name="minus" class="quantity__button hidden" disabled aria-label="{{ 'products.product.quantity.decrease' | t: product: item.product.title | escape }}">
                                <svg width="16" height="16" viewBox="0 0 15 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <path d="M2.6875 7H12.3125" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                              </button>
                              <input 
                                class="quantity__input"
                                disabled
                                type="text"
                                name="updates[]"
                                value="{{ item.quantity }}"
                                id="Quantity-{{ section.id }}-{{ item.index | plus: 1 }}"
                                inputmode="numeric"
                                autocomplete="off"
                                aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                                data-index="{{ item.index | plus: 1 }}"
                                data-quantity-variant-id="{{ item.variant.id }}"
                                data-cart-quantity="{{ cart | item_count_for_variant: item.variant.id }}"
                                size="2"
                                min="0"
                                data-min="{{ item.variant.quantity_rule.min }}"
                                {% if item.variant.quantity_rule.max != null %}
                                  max="{{ item.variant.quantity_rule.max }}"
                                {% endif %}
                                {% comment %} {% if item.variant.quantity_rule.max != null  %}
                                  max="{{ item.variant.quantity_rule.max }}"
                                {% elsif  item.variant.id=='7850335305827' %}  
                                  max="1"
                                {% endif %} {% endcomment %}
                                step="{{ item.variant.quantity_rule.increment }}"
                              />
                              <button type="button" name="plus" disabled class="quantity__button hidden" aria-label="{{ 'products.product.quantity.increase' | t: product: item.product.title | escape }}">
                                <svg width="16" height="16" viewBox="0 0 15 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <path d="M2.6875 7H12.3125" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                  <path d="M7.5 2.1875V11.8125" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                              </button>
                            </div>
                          {%- endunless -%}
                        </div>
                      </div>
                    </div>
                    {%- if section.settings.enable_cart_recommendations -%}
                      {%- render 'cart-drawer-products-recommendation',
                        section_id: section.id
                        product_id: item.product_id,
                        heading: section.settings.cart_recommendations_heading,
                        limit: section.settings.cart_recommendations_limit
                      -%}
                    {%- endif -%}
                    {% liquid
                      assign collections = ''
                      for collection in item.product.collections
                        assign collections = collections | append: collection.id | append: ','
                      endfor
                    %}
                    <foxkit-incart-upsell
                      data-collections="{{ collections | remove_last: ',' }}"
                      data-product-title="{{ item.product.title }}"
                      data-product-id="{{ item.product_id }}"
                    ></foxkit-incart-upsell>
                  </li>
                {%- endcapture -%}

                  {%- liquid
                    unless is_gift_wrap_item
                      echo cart_item
                    else
                      assign cart_gift_wrap_item = cart_item
                    endunless
                  -%}
                {%- endfor -%}
                {%- liquid
                  if cart_gift_wrap_item
                    echo cart_gift_wrap_item
                  endif
                -%}
              </ul>
            </cart-items>
          </div>
        </div>
        <div
          id="CartDrawerFooter-{{ section.id }}"
          class="drawer__footer cart-drawer__footer grid gap-4{% if cart == empty %} hidden{% endif %}"
        >
          <div class="drawer__footer-head">
            {%- render 'gift-wrapping',
              section_id: section.id,
              gift_wrapping: gift_wrapping,
              gift_wrap_id: gift_wrap_id,
              gift_wraps_in_cart: gift_wraps_in_cart,
              items_in_cart: items_in_cart
            -%}
            {%- if section.settings.show_cart_note or section.settings.show_shipping_rates_calculator -%}
              <div class="flex gap-6 cart-drawer__addons">
                {%- if section.settings.show_cart_note -%}
                  <button
                    type="button"
                    class="btn--inherit flex gap-2 items-center justify-center"
                    aria-controls="CartNote-{{ section.id }}"
                    aria-expanded="false"
                  >
                    {%- render 'icon-pencil' -%}
                    <span class="reversed-link">{{ 'general.cart.note.title' | t }}</span>
                  </button>
                {%- endif -%}
                {% comment %} {%- if section.settings.show_shipping_rates_calculator -%}
                  <button
                    type="button"
                    class="btn--inherit flex gap-2 items-center justify-center"
                    aria-controls="ShippingCalculator-{{ section.id }}"
                    aria-expanded="false"
                  >
                    {%- render 'icon-clock' -%}
                    <span class="reversed-link">{{ 'general.cart.shipping_calculator.title' | t }}</span>
                  </button>
                {%- endif -%} {% endcomment %}

                {%- if section.settings.show_cart_note -%}
                  <modal-component
                    id="CartNote-{{ section.id }}"
                    class="drawer cart-addons-drawer drawer--bottom"
                    hidden
                  >
                    <div class="fixed-overlay absolute" aria-controls="CartNote-{{ section.id }}"></div>
                    <div class="drawer__inner">
                      <button aria-controls="CartNote-{{ section.id }}" class="drawer__close-btn z-1">
                        {%- render 'icon-close' -%}
                      </button>
                      <div class="drawer__content cart-addons-drawer__content grid gap-5">
                        <h4>{{ 'general.cart.note.title' | t }}</h4>
                        <cart-note class="flex flex-col items-start gap-5">
                          <div class="form-field w-full">
                            <textarea
                              name="note"
                              class="form-control form-control--textarea"
                              rows="5"
                              placeholder="{{ 'general.cart.note.caption' | t }}"
                              id="CartNoteForm-{{ section.id }}"
                            >{{ cart.note }}</textarea>
                            <label class="visually-hidden" for="CartNoteForm-{{ section.id }}">
                              {{- 'general.cart.note.title' | t -}}
                            </label>
                          </div>
                          <button
                            class="btn btn--primary"
                            type="button"
                            aria-controls="CartNote-{{ section.id }}"
                            aria-expanded="false"
                          >
                            <span>{{ 'general.cart.note.button' | t }}</span>
                          </button>
                        </cart-note>
                      </div>
                    </div>
                  </modal-component>
                {%- endif -%}
                {%- if section.settings.show_shipping_rates_calculator -%}
                  <calculate-shipping
                    id="ShippingCalculator-{{ section.id }}"
                    class="drawer cart-addons-drawer drawer--bottom"
                    hidden
                    data-show="fasle"
                  >
                    <div class="fixed-overlay absolute" aria-controls="ShippingCalculator-{{ section.id }}"></div>
                    <div class="drawer__inner cart-addons-drawer__inner flex flex-col w-full h-full">
                      <button aria-controls="ShippingCalculator-{{ section.id }}" class="drawer__close-btn z-1">
                        {%- render 'icon-close' -%}
                      </button>
                      <div class="drawer__content v-scrollable cart-addons-drawer__content flex flex-col gap-4">
                        <h4>{{ 'general.cart.shipping_calculator.title' | t }}</h4>
                        <form
                          class="grid gap-4"
                          action="{{ routes.cart_url }}"
                          method="POST"
                          novalidate
                          is="shipping-calculator"
                        >
                          <country-province
                            class="grid gap-4"
                            {% if shop.customer_accounts_enabled and customer %}
                              data-country="{{ customer.default_address.country }}"
                              {%- if customer.default_address.province != '' %}
                                data-province="{{ customer.default_address.province }}"
                              {%- endif -%}
                            {% endif %}
                          >
                            <div class="form-field reset-spacing">
                              <label class="form-label" for="ShippingCalculatorCountry-{{ section.id }}">
                                {{- 'customer.addresses.country' | t -}}
                              </label>
                              <div class="select">
                                <select
                                  name="address[country]"
                                  class="form-control form-control--select"
                                  autocomplete="country"
                                  id="ShippingCalculatorCountry-{{ section.id }}"
                                >
                                  <template>{{- all_country_option_tags -}}</template>
                                </select>
                                {%- render 'icon-caret-down' -%}
                              </div>
                            </div>
                            <div class="form-field reset-spacing" hidden>
                              <label class="form-label" for="ShippingCalculatorProvince-{{ section.id }}">
                                {{- 'customer.addresses.province' | t -}}
                              </label>
                              <div class="select">
                                <select
                                  name="address[province]"
                                  class="form-control form-control--select"
                                  autocomplete="address-level1"
                                  id="ShippingCalculatorProvince-{{ section.id }}"
                                ></select>
                                {%- render 'icon-caret-down' -%}
                              </div>
                            </div>
                          </country-province>
                          <div class="form-field">
                            <label class="form-label" for="ShippingCalculatorZip-{{ section.id }}">
                              {{- 'customer.addresses.zip' | t -}}
                            </label>
                            <input
                              name="address[zip]"
                              class="form-control form-control--input"
                              type="text"
                              autocapitalize="characters"
                              autocomplete="postal-code"
                              placeholder=" "
                              id="ShippingCalculatorZip-{{ section.id }}"
                              {% if shop.customer_accounts_enabled and customer %}
                                value="{{ customer.default_address.zip }}"
                              {% endif %}
                            >
                          </div>
                          <div class="">
                            <button class="btn btn--primary" type="submit">
                              <span>{{ 'general.cart.shipping_calculator.button' | t }}</span>
                              {%- render 'loading-spinner' -%}
                            </button>
                          </div>
                          <div class="grid gap-3"></div>
                        </form>
                      </div>
                    </div>
                  </calculate-shipping>
                {%- endif -%}
              </div>
            {%- endif -%}
          </div>
          <div class="drawer__footer-body">
            <div class="grid gap-4">
              <div class="grid gap-2">
                {%- if cart.cart_level_discount_applications.size > 0 -%}
                  <ul
                    class="discounts list-unstyled flex gap-1"
                    role="list"
                    aria-label="{{ 'customer.order.discount' | t }}"
                  >
                    {%- for discount in cart.cart_level_discount_applications -%}
                      <li class="discount text-sm flex items-center">
                        {% render 'icon-discount' %}
                        <span>{{- discount.title -}}</span>
                        <span class="font-body-bold">(-{{ discount.total_allocated_amount | money }})</span>
                      </li>
                    {%- endfor -%}
                  </ul>
                {%- endif -%}
                <div class="totals flex justify-between items-center">
                  <span class="totals__subtotal h4">
                    {{- 'sections.cart.estimated_total' | t -}}
                  </span>
                  <span class="totals__subtotal-value h4 font-body-bolder">
                    {{- cart.total_price | money_with_currency -}}
                  </span>
                </div>
                <div class="tax-note">
                  {%- liquid
                    if cart.taxes_included and shop.shipping_policy.body != blank
                      echo 'sections.cart.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url
                    elsif cart.taxes_included
                      echo 'sections.cart.taxes_included_but_shipping_at_checkout' | t
                    elsif shop.shipping_policy.body != blank
                      echo 'sections.cart.taxes_and_shipping_policy_at_checkout_html' | t: link: shop.shipping_policy.url
                    else
                      echo 'sections.cart.taxes_and_shipping_at_checkout' | t
                    endif
                  -%}
                </div>
              </div>
              <form
                action="{{ routes.cart_url }}"
                method="POST"
                novalidate
                class="drawer__footer-buttons flex flex-wrap gap-4"
              >
                <a href="{{ routes.cart_url }}" class="btn btn--secondary">
                  {{ 'general.cart.view_empty_cart' | t }}
                </a>
                <button class="btn btn--primary" type="submit" name="checkout">
                  {{ 'sections.cart.checkout' | t }}
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </cart-drawer>
{%- endif -%}

{% schema %}
{
  "name": "t:sections.cart-drawer.name",
  "settings": [
    {
      "type": "paragraph",
      "content": "[Read How-to](https://foxecom.link/wdOue47)"
    },
    {
      "type": "header",
      "content": "t:sections.all.general.name"
    },
    {
      "type": "checkbox",
      "id": "show_cart_note",
      "label": "t:sections.cart-drawer.settings.show_cart_note.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_shipping_rates_calculator",
      "label": "t:sections.cart-drawer.settings.show_shipping_rates_calculator.label"
    },
    {
      "type": "checkbox",
      "id": "show_free_shipping_goal",
      "label": "t:sections.cart-drawer.settings.show_free_shipping_goal.label",
      "default": true,
      "info": "t:settings_schema.cart.settings.free_shipping_minimum_amount.info"
    },
    {
      "type": "header",
      "content": "t:sections.cart-drawer.settings.header__1.content"
    },
    {
      "type": "checkbox",
      "id": "enable_cart_recommendations",
      "label": "t:sections.cart-drawer.settings.enable_cart_recommendations.label",
      "default": true
    },
    {
      "type": "text",
      "id": "cart_recommendations_heading",
      "label": "t:sections.cart-drawer.settings.cart_recommendations_heading.label",
      "default": "You may also like"
    },
    {
      "type": "range",
      "id": "cart_recommendations_limit",
      "label": "t:sections.cart-drawer.settings.cart_recommendations_limit.label",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 3
    }
  ]
}
{% endschema %}
<style>
  /* 禁用 Bundle 产品的链接样式 */
  .cart-item[data-bundle-item="true"] .cart-item__media,
  .cart-item[data-bundle-item="true"] .cart-item__title {
    pointer-events: none;
    cursor: default;
  }
  
  .cart-item[data-bundle-item="true"] .cart-item__media {
    opacity: 0.9;
  }
  
  /* 隐藏 Bundle 产品的价格 */
  .cart-item[data-bundle-item="true"] .cart-item__prices {
    display: none;
  }
</style>

<script>
  (function initFreeGiftAutoRemove() {
    if (window._freeGiftAutoRemoveInitialized) return;
    window._freeGiftAutoRemoveInitialized = true;
    
    // 清理抽屉/模态状态，防止页面卡死
    function resetBodyScrollState() {
      document.documentElement.classList.remove('drawer-open');
      document.body.classList.remove('modal-show', 'nodal-show', 'body--no-scrollbar');
      document.body.style.removeProperty('overflow');
      document.body.style.removeProperty('padding-right');
    }
    window.addFreeGiftMapping = function(mainProductId, freeGiftVariantId) {
      try {
        const mappings = JSON.parse(localStorage.getItem('free_gift_mappings') || '{}');
        const key = String(mainProductId);
        if (!mappings[key]) mappings[key] = [];
        const variantIdStr = String(freeGiftVariantId);
        if (!mappings[key].includes(variantIdStr)) {
          mappings[key].push(variantIdStr);
        }
        localStorage.setItem('free_gift_mappings', JSON.stringify(mappings));
      } catch (e) {
      }
    };
    
    // 监听删除按钮点击，自动删除关联的免费赠品
    function attachRemoveListeners() {
      document.querySelectorAll('.cart-item__remove').forEach(removeBtn => {
        if (removeBtn._freeGiftListenerAttached) return;
        removeBtn._freeGiftListenerAttached = true;
        
        removeBtn.addEventListener('click', function(e) {
          const cartItem = this.closest('.cart-item');
          if (!cartItem) return;
          
          const isFreeGift = cartItem.dataset.freeGift === 'true';
          if (isFreeGift) {
            // 免费礼物被删除，快速触发恢复检查（延迟等待Shopify完成删除）
            setTimeout(() => {
              document.dispatchEvent(new CustomEvent('free-gift:check'));
            }, 350);
            return;
          }
          
          const productId = cartItem.dataset.productId;
          if (!productId) return;
          
          const mappings = JSON.parse(localStorage.getItem('free_gift_mappings') || '{}');
          const freeGiftVariantIds = mappings[String(productId)] || [];
          
          if (freeGiftVariantIds.length === 0) return;
          
          setTimeout(async () => {
            try {
              // 获取当前购物车
              const cartResponse = await fetch('/cart.js');
              const cart = await cartResponse.json();
              
              // 找到所有需要删除的免费赠品的key
              const keysToRemove = [];
              cart.items.forEach(item => {
                const itemVariantId = String(item.variant_id);
                if (freeGiftVariantIds.includes(itemVariantId)) {
                  keysToRemove.push(item.key);
                }
              });
              
              if (keysToRemove.length === 0) return;
              
              // 构建updates对象：{ key: 0, key: 0, ... }
              const updates = {};
              keysToRemove.forEach(key => {
                updates[key] = 0;
              });
              
              // 批量删除
              const updateResponse = await fetch('/cart/update.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ updates: updates })
              });
              
              if (updateResponse.ok) {
                const updatedCart = await updateResponse.json();
                
                // 更新购物车数量显示
                document.querySelectorAll('cart-count').forEach(countEl => {
                  if (updatedCart.item_count > 99) {
                    countEl.innerHTML = `<span class="text-sm">99+</span>`;
                    countEl.classList.add('cart-count--small-medium');
                  } else {
                    countEl.innerText = updatedCart.item_count;
                    countEl.classList.remove('cart-count--small-medium');
                  }
                  countEl.hidden = updatedCart.item_count === 0;
                });
                
                document.documentElement.classList[updatedCart.item_count === 0 ? 'remove' : 'add']('cart-has-items');
                
                // 若购物车已空，确保抽屉关闭并恢复页面滚动（防止卡死）
                if (updatedCart.item_count === 0) {
                  const cartDrawerEl = document.querySelector('cart-drawer');
                  if (cartDrawerEl) {
                    cartDrawerEl.removeAttribute('open');
                    cartDrawerEl.setAttribute('hidden', 'hidden');
                  }
                  resetBodyScrollState();
                }
                
                // 触发购物车刷新
                setTimeout(() => {
                  document.dispatchEvent(new CustomEvent('cart:refresh'));
                }, 100);
              }
              
              // 删除映射
              delete mappings[String(productId)];
              localStorage.setItem('free_gift_mappings', JSON.stringify(mappings));
              
            } catch (error) {
            }
          }, 600);
        });
      });
    }
    
    // 初始化并监听DOM变化
    attachRemoveListeners();
    
    const observer = new MutationObserver(() => attachRemoveListeners());
    const cartDrawer = document.querySelector('cart-drawer');
    const cartPage = document.querySelector('.cart');
    if (cartDrawer) observer.observe(cartDrawer, { childList: true, subtree: true });
    if (cartPage) observer.observe(cartPage, { childList: true, subtree: true });
    (function monitorFreeGiftDeletion() {
      if (window._freeGiftMonitorInitialized) return;
      window._freeGiftMonitorInitialized = true;
      let isRestoring = false;
      let restoreTimer = null;
      let lastCheckTime = 0;
      const MIN_CHECK_INTERVAL = 500; // 最小检查间隔500ms
      
      // 防抖函数 - 避免频繁触发
      function debounceRestore(delay = 300) {
        if (restoreTimer) clearTimeout(restoreTimer);
        restoreTimer = setTimeout(() => {
          const now = Date.now();
          if (now - lastCheckTime >= MIN_CHECK_INTERVAL && !isRestoring) {
            lastCheckTime = now;
            checkAndRestoreFreeGifts();
          }
        }, delay);
      }
      
      // 检查并恢复被删除的免费礼物
      async function checkAndRestoreFreeGifts() {
        if (isRestoring) return;
        
        // 检查是否正在从产品页替换礼物
        if (sessionStorage.getItem('_replacing_free_gifts') === 'true') {
          return; // 如果是替换操作，不自动恢复
        }
        
        try {
          isRestoring = true;
          
          const cartResponse = await fetch('/cart.js');
          const cart = await cartResponse.json();
          
          if (!cart.items || cart.items.length === 0) {
            isRestoring = false;
            return;
          }
          
          const mappings = JSON.parse(localStorage.getItem('free_gift_mappings') || '{}');
          
          // 快速检查：如果没有映射，直接返回
          if (Object.keys(mappings).length === 0) {
            isRestoring = false;
            return;
          }
          
          // 先清理映射：移除不在购物车中的主产品
          const mainProductsInCart = new Set();
          const currentFreeGifts = new Set();
          
          cart.items.forEach(item => {
            const isFreeGift = item.properties && item.properties._free_gift === 'true';
            if (isFreeGift) {
              currentFreeGifts.add(String(item.variant_id));
            } else {
              mainProductsInCart.add(String(item.product_id));
            }
          });
          
          // 清除不存在的主产品映射
          let mappingsCleaned = false;
          Object.keys(mappings).forEach(mainProductId => {
            if (!mainProductsInCart.has(mainProductId)) {
              delete mappings[mainProductId];
              mappingsCleaned = true;
            }
          });
          
          if (mappingsCleaned) {
            localStorage.setItem('free_gift_mappings', JSON.stringify(mappings));
          }
          
          // 快速检查：收集所有需要恢复的礼物
          const itemsToAdd = [];
          
          for (const mainProductId of Object.keys(mappings)) {
            if (!mainProductsInCart.has(mainProductId)) continue;
            
            const expectedFreeGiftIds = mappings[mainProductId] || [];
            
            // 找出缺失的礼物
            expectedFreeGiftIds.forEach(variantId => {
              if (!currentFreeGifts.has(variantId)) {
                itemsToAdd.push({
                  id: parseInt(variantId),
                  quantity: 1,
                  properties: {
                    _free_gift: 'true',
                    _main_product_id: String(mainProductId),
                    _gift_type: 'gratisgeschenk'
                  }
                });
              }
            });
          }
          
          // 如果有需要恢复的礼物，批量添加
          if (itemsToAdd.length > 0) {
            const response = await fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ items: itemsToAdd })
            });
            
            if (response.ok) {
              // 获取更新后的购物车
              const updatedCartResponse = await fetch('/cart.js');
              const updatedCart = await updatedCartResponse.json();
              
              // 批量更新 cart-count 显示
              requestAnimationFrame(() => {
                document.querySelectorAll('cart-count').forEach(countEl => {
                  if (updatedCart.item_count > 99) {
                    countEl.innerHTML = `<span class="text-sm">99+</span>`;
                    countEl.classList.add('cart-count--small-medium');
                  } else {
                    countEl.innerText = updatedCart.item_count;
                    countEl.classList.remove('cart-count--small-medium');
                  }
                  countEl.hidden = updatedCart.item_count === 0;
                });
                
                document.documentElement.classList[updatedCart.item_count === 0 ? 'remove' : 'add']('cart-has-items');
              });
              
              // 异步更新 UI（不阻塞）
              const cartDrawerEl = document.querySelector('cart-drawer');
              const sectionId = cartDrawerEl ? cartDrawerEl.getAttribute('data-section-id') : null;
              
              if (sectionId) {
                // 使用异步方式更新，不阻塞主流程
                fetch(`/?sections=${sectionId}`)
                  .then(res => res.json())
                  .then(data => {
                    const sectionHTML = data[sectionId];
                    if (!sectionHTML) return;
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(sectionHTML, 'text/html');
                    const newDrawerContent = doc.querySelector(`#CartDrawer-${sectionId}`);
                    const currentDrawerContent = document.querySelector(`#CartDrawer-${sectionId}`);
                    
                    if (newDrawerContent && currentDrawerContent) {
                      // 使用 requestAnimationFrame 优化 DOM 操作
                      requestAnimationFrame(() => {
                        currentDrawerContent.innerHTML = newDrawerContent.innerHTML;
                        
                        // 延迟重新绑定监听器
                        setTimeout(() => {
                          if (typeof attachRemoveListeners === 'function') {
                            attachRemoveListeners();
                          }
                        }, 50);
                      });
                    }
                  })
                  .catch(() => {})
                  .finally(() => {
                    if (updatedCart.item_count === 0) {
                      resetBodyScrollState();
                    }
                  });
              } else if (updatedCart.item_count === 0) {
                resetBodyScrollState();
              }
            }
          }
          
          isRestoring = false;
        } catch (error) {
          isRestoring = false;
        }
      }
      
      // 监听删除事件 - 立即触发恢复（快速响应）
      document.addEventListener('free-gift:check', () => debounceRestore(100));
      
      // 使用 MutationObserver 监听购物车 DOM 变化（更实时）
      const cartDrawer = document.querySelector('cart-drawer');
      if (cartDrawer) {
        const observer = new MutationObserver((mutations) => {
          // 检查是否有礼物被删除
          const hasCartItemRemoved = mutations.some(mutation => 
            mutation.type === 'childList' && 
            mutation.removedNodes.length > 0 &&
            Array.from(mutation.removedNodes).some(node => 
              node.classList && node.classList.contains('cart-item')
            )
          );
          
          if (hasCartItemRemoved && !isRestoring) {
            // 有购物车项被删除，快速检查
            debounceRestore(200);
          }
        });
        
        const cartBody = cartDrawer.querySelector('.cart-drawer__body');
        if (cartBody) {
          observer.observe(cartBody, {
            childList: true,
            subtree: true
          });
        }
      }
      
      // 降低定期检查频率（作为备用机制）
      setInterval(() => {
        if (!isRestoring && sessionStorage.getItem('_replacing_free_gifts') !== 'true') {
          debounceRestore(500);
        }
      }, 5000); // 从3秒改为5秒
      
      // 页面加载时检查一次
      setTimeout(() => {
        if (!isRestoring) {
          lastCheckTime = Date.now();
          checkAndRestoreFreeGifts();
        }
      }, 1000);
    })();
  })();
</script>

<script>
  (function initBundleItemAutoRemove() {
    if (window._bundleItemAutoRemoveInitialized) return;
    window._bundleItemAutoRemoveInitialized = true;
    
    function resetBodyScrollState() {
      document.documentElement.classList.remove('drawer-open');
      document.body.classList.remove('modal-show', 'nodal-show', 'body--no-scrollbar');
      document.body.style.removeProperty('overflow');
      document.body.style.removeProperty('padding-right');
    }
    
    // 获取 Bundle 映射
    function getBundleMappings() {
      try {
        return JSON.parse(localStorage.getItem('bundle_product_mappings') || '{}');
      } catch (e) {
        return {};
      }
    }
    
    function removeBundleMapping(hostVariantId) {
      try {
        const mappings = getBundleMappings();
        delete mappings[String(hostVariantId)];
        localStorage.setItem('bundle_product_mappings', JSON.stringify(mappings));
      } catch (e) {
      }
    }
    
    function attachBundleRemoveListeners() {
      document.querySelectorAll('.cart-item__remove').forEach(removeBtn => {
        if (removeBtn._bundleItemListenerAttached) return;
        removeBtn._bundleItemListenerAttached = true;
        removeBtn.addEventListener('click', function(e) {
          const cartItem = this.closest('.cart-item');
          if (!cartItem) return;
          const variantId = cartItem.dataset.variantId;
          if (!variantId) return;
          const mappings = getBundleMappings();
          const bundleVariantIds = mappings[String(variantId)];
          
          if (!bundleVariantIds || bundleVariantIds.length === 0) {
            return;
          }
          
          
          setTimeout(async () => {
            try {
              const cartResponse = await fetch('/cart.js');
              const cart = await cartResponse.json();
              if (!cart.items || cart.items.length === 0) {
                removeBundleMapping(variantId);
                return;
              }
              const keysToRemove = [];
              cart.items.forEach(item => {
                const itemVariantId = String(item.variant_id);
                if (bundleVariantIds.includes(itemVariantId)) {
                  keysToRemove.push({ key: item.key, title: item.title, variantId: itemVariantId });
                }
              });
              
              if (keysToRemove.length === 0) {
                removeBundleMapping(variantId);
                return;
              }
              
              // 构建 updates 对象：{ key: 0, key: 0, ... }
              const updates = {};
              keysToRemove.forEach(k => {
                updates[k.key] = 0;
              });
              
              // 批量删除
              const updateResponse = await fetch('/cart/update.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ updates: updates })
              });
              
              if (updateResponse.ok) {
                const updatedCart = await updateResponse.json();
                
                // 更新购物车数量显示
                document.querySelectorAll('cart-count').forEach(countEl => {
                  if (updatedCart.item_count > 99) {
                    countEl.innerHTML = `<span class="text-sm">99+</span>`;
                    countEl.classList.add('cart-count--small-medium');
                  } else {
                    countEl.innerText = updatedCart.item_count;
                    countEl.classList.remove('cart-count--small-medium');
                  }
                  countEl.hidden = updatedCart.item_count === 0;
                });
                
                document.documentElement.classList[updatedCart.item_count === 0 ? 'remove' : 'add']('cart-has-items');
                
                // 若购物车已空，确保抽屉关闭并恢复页面滚动
                if (updatedCart.item_count === 0) {
                  const cartDrawerEl = document.querySelector('cart-drawer');
                  if (cartDrawerEl) {
                    cartDrawerEl.removeAttribute('open');
                    cartDrawerEl.setAttribute('hidden', 'hidden');
                  }
                  resetBodyScrollState();
                }
                
                // 触发购物车刷新（异步更新 UI，不刷新页面）
                setTimeout(() => {
                  document.dispatchEvent(new CustomEvent('cart:refresh'));
                }, 100);
                
              }
              
              // 删除映射
              removeBundleMapping(variantId);
              
            } catch (error) {
              console.error('[Bundle Auto Remove] 删除组合产品失败:', error);
              removeBundleMapping(variantId);
            }
          }, 600);
        });
      });
    }
    
    // 初始化并监听 DOM 变化
    attachBundleRemoveListeners();
    
    const observer = new MutationObserver(() => {
      attachBundleRemoveListeners();
    });
    const cartDrawer = document.querySelector('cart-drawer');
    const cartPage = document.querySelector('.cart');
    if (cartDrawer) observer.observe(cartDrawer, { childList: true, subtree: true });
    if (cartPage) observer.observe(cartPage, { childList: true, subtree: true });
    
  })();
</script>